<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>nmea.c Source File</title>
<link href="dox.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>nmea.c</h1><a href="nmea_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file nmea.c \brief NMEA protocol function library. */</span>
00002 <span class="comment">//*****************************************************************************</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// File Name    : 'nmea.c'</span>
00005 <span class="comment">// Title        : NMEA protocol function library</span>
00006 <span class="comment">// Author       : Pascal Stang - Copyright (C) 2002</span>
00007 <span class="comment">// Created      : 2002.08.27</span>
00008 <span class="comment">// Revised      : 2002.08.27</span>
00009 <span class="comment">// Version      : 0.1</span>
00010 <span class="comment">// Target MCU   : Atmel AVR Series</span>
00011 <span class="comment">// Editor Tabs  : 4</span>
00012 <span class="comment">//</span>
00013 <span class="comment">// NOTE: This code is currently below version 1.0, and therefore is considered</span>
00014 <span class="comment">// to be lacking in some functionality or documentation, or may not be fully</span>
00015 <span class="comment">// tested.  Nonetheless, you can expect most functions to work.</span>
00016 <span class="comment">//</span>
00017 <span class="comment">// This code is distributed under the GNU Public License</span>
00018 <span class="comment">//      which can be found at http://www.gnu.org/licenses/gpl.txt</span>
00019 <span class="comment">//</span>
00020 <span class="comment">//*****************************************************************************</span>
00021 
00022 <span class="preprocessor">#ifndef WIN32</span>
00023 <span class="preprocessor"></span><span class="preprocessor">    #include &lt;avr/io.h&gt;</span>
00024 <span class="preprocessor">    #include &lt;avr/signal.h&gt;</span>
00025 <span class="preprocessor">    #include &lt;avr/interrupt.h&gt;</span>
00026 <span class="preprocessor">    #include &lt;avr/pgmspace.h&gt;</span>
00027 <span class="preprocessor">    #include &lt;string.h&gt;</span>
00028 <span class="preprocessor">    #include &lt;stdlib.h&gt;</span>
00029 <span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="preprocessor">#include "<a class="code" href="global_8h.html">global.h</a>"</span>
00032 <span class="preprocessor">#include "<a class="code" href="buffer_8h.html">buffer.h</a>"</span>
00033 <span class="preprocessor">#include "<a class="code" href="rprintf_8h.html">rprintf.h</a>"</span>
00034 <span class="preprocessor">#include "<a class="code" href="gps_8h.html">gps.h</a>"</span>
00035 
00036 <span class="preprocessor">#include "<a class="code" href="nmea_8h.html">nmea.h</a>"</span>
00037 
00038 <span class="comment">// Program ROM constants</span>
00039 
00040 <span class="comment">// Global variables</span>
00041 <span class="keyword">extern</span> GpsInfoType GpsInfo;
00042 <span class="preprocessor">#define BUFFERSIZE  80</span>
00043 <span class="preprocessor"></span>u08 NmeaPacket[BUFFERSIZE];
00044 u08 debug;
00045 
00046 <span class="keywordtype">void</span> nmeaInit(<span class="keywordtype">void</span>)
00047 {
00048     debug = 0;
00049 }
00050 
00051 u08 nmeaProcess(cBuffer* rxBuffer)
00052 {
00053     u08 foundpacket = FALSE;
00054     u08 startFlag = FALSE;
00055     <span class="comment">//u08 data;</span>
00056     u08 i,j;
00057 
00058     <span class="comment">// process the receive buffer</span>
00059     <span class="comment">// go through buffer looking for packets</span>
00060     <span class="keywordflow">while</span>(rxBuffer-&gt;datalength)
00061     {
00062         <span class="comment">// look for a start of NMEA packet</span>
00063         <span class="keywordflow">if</span>(<a class="code" href="buffer_8c.html#a3">bufferGetAtIndex</a>(rxBuffer,0) == <span class="charliteral">'$'</span>)
00064         {
00065             <span class="comment">// found start</span>
00066             startFlag = TRUE;
00067             <span class="comment">// done looking for start</span>
00068             <span class="keywordflow">break</span>;
00069         }
00070         <span class="keywordflow">else</span>
00071             <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(rxBuffer);
00072     }
00073     
00074     <span class="comment">// if we detected a start, look for end of packet</span>
00075     <span class="keywordflow">if</span>(startFlag)
00076     {
00077         <span class="keywordflow">for</span>(i=1; i&lt;(rxBuffer-&gt;datalength)-1; i++)
00078         {
00079             <span class="comment">// check for end of NMEA packet &lt;CR&gt;&lt;LF&gt;</span>
00080             <span class="keywordflow">if</span>((<a class="code" href="buffer_8c.html#a3">bufferGetAtIndex</a>(rxBuffer,i) == <span class="charliteral">'\r'</span>) &amp;&amp; (<a class="code" href="buffer_8c.html#a3">bufferGetAtIndex</a>(rxBuffer,i+1) == <span class="charliteral">'\n'</span>))
00081             {
00082                 <span class="comment">// have a packet end</span>
00083                 <span class="comment">// dump initial '$'</span>
00084                 <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(rxBuffer);
00085                 <span class="comment">// copy packet to NmeaPacket</span>
00086                 <span class="keywordflow">for</span>(j=0; j&lt;(i-1); j++)
00087                     NmeaPacket[j] = <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(rxBuffer);
00088                 <span class="comment">// null terminate it</span>
00089                 NmeaPacket[j] = 0;
00090                 <span class="comment">// dump &lt;CR&gt;&lt;LF&gt; from rxBuffer</span>
00091                 <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(rxBuffer);
00092                 <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(rxBuffer);
00093 
00094                 <span class="keywordflow">if</span>(debug)
00095                 {
00096                     rprintf(<span class="stringliteral">"Rx NMEA packet type: "</span>);
00097                     <a class="code" href="rprintf_8c.html#a9">rprintfStrLen</a>(NmeaPacket, 0, 5);
00098                     <a class="code" href="rprintf_8c.html#a9">rprintfStrLen</a>(NmeaPacket, 5, (i-1)-5);
00099                     <a class="code" href="rprintf_8c.html#a11">rprintfCRLF</a>();
00100                 }
00101                 <span class="comment">// found a packet</span>
00102                 <span class="comment">// done with this processing session</span>
00103                 foundpacket = TRUE;
00104                 <span class="keywordflow">break</span>;
00105             }
00106         }
00107     }
00108 
00109     <span class="keywordflow">if</span>(foundpacket)
00110     {
00111         <span class="comment">// check message type and process appropriately</span>
00112         <span class="keywordflow">if</span>(!strncmp(NmeaPacket, <span class="stringliteral">"GPGGA"</span>, 5))
00113             nmeaProcessGPGGA(NmeaPacket);
00114         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strncmp(NmeaPacket, <span class="stringliteral">"GPVTG"</span>, 5))
00115             nmeaProcessGPVTG(NmeaPacket);
00116     }
00117     <span class="keywordflow">return</span> foundpacket;
00118 }
00119 
00120 <span class="keywordtype">void</span> nmeaProcessGPGGA(u08* packet)
00121 {
00122     u08 i;
00123     <span class="keywordtype">char</span>* endptr;
00124 
00125     <span class="keywordflow">if</span>(debug)
00126     {
00127         rprintf(<span class="stringliteral">"NMEA: "</span>);
00128         <a class="code" href="rprintf_8c.html#a8">rprintfStr</a>(packet);
00129         <a class="code" href="rprintf_8c.html#a11">rprintfCRLF</a>();
00130     }
00131 
00132     <span class="comment">// start parsing just after "GPGGA,"</span>
00133     i = 6;
00134 
00135     <span class="comment">// get UTC time [hhmmss.sss]</span>
00136     GpsInfo.PosLLA.TimeOfFix.f = strtod(&amp;packet[i], &amp;endptr);
00137     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: latitude</span>
00138     
00139     <span class="comment">// get latitude [ddmm.mmmmm]</span>
00140     GpsInfo.PosLLA.lat.f = strtod(&amp;packet[i], &amp;endptr);
00141     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: N/S indicator</span>
00142     
00143     <span class="comment">// correct latitute for N/S</span>
00144     <span class="keywordflow">if</span>(packet[i] == <span class="charliteral">'S'</span>) GpsInfo.PosLLA.lat.f = -GpsInfo.PosLLA.lat.f;
00145     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: longitude</span>
00146     
00147     <span class="comment">// get longitude [ddmm.mmmmm]</span>
00148     GpsInfo.PosLLA.lon.f = strtod(&amp;packet[i], &amp;endptr);
00149     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: E/W indicator</span>
00150 
00151     <span class="comment">// correct latitute for E/W</span>
00152     <span class="keywordflow">if</span>(packet[i] == <span class="charliteral">'W'</span>) GpsInfo.PosLLA.lon.f = -GpsInfo.PosLLA.lon.f;
00153     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: position fix status</span>
00154 
00155     <span class="comment">// position fix status</span>
00156     <span class="comment">// 0 = Invalid, 1 = Valid SPS, 2 = Valid DGPS, 3 = Valid PPS</span>
00157     <span class="comment">// check for good position fix</span>
00158     <span class="keywordflow">if</span>( (packet[i] != <span class="charliteral">'0'</span>) &amp;&amp; (packet[i] != <span class="charliteral">','</span>) )
00159         GpsInfo.PosLLA.updates++;
00160     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: satellites used</span>
00161     
00162     <span class="comment">// get number of satellites used in GPS solution</span>
00163     GpsInfo.numSVs = atoi(&amp;packet[i]);
00164     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: HDOP (horizontal dilution of precision)</span>
00165     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: altitude</span>
00166     
00167     <span class="comment">// get altitude (in meters)</span>
00168     GpsInfo.PosLLA.alt.f = strtod(&amp;packet[i], &amp;endptr);
00169 
00170     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: altitude units, always 'M'</span>
00171     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: geoid seperation</span>
00172     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: seperation units</span>
00173     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: DGPS age</span>
00174     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: DGPS station ID</span>
00175     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">'*'</span>);              <span class="comment">// next field: checksum</span>
00176 }
00177 
00178 <span class="keywordtype">void</span> nmeaProcessGPVTG(u08* packet)
00179 {
00180     u08 i;
00181     <span class="keywordtype">char</span>* endptr;
00182 
00183     <span class="keywordflow">if</span>(debug)
00184     {
00185         rprintf(<span class="stringliteral">"NMEA: "</span>);
00186         <a class="code" href="rprintf_8c.html#a8">rprintfStr</a>(packet);
00187         <a class="code" href="rprintf_8c.html#a11">rprintfCRLF</a>();
00188     }
00189 
00190     <span class="comment">// start parsing just after "GPVTG,"</span>
00191     i = 6;
00192     <span class="comment">// get course (true north ref) in degrees [ddd.dd]</span>
00193     GpsInfo.VelHS.heading.f = strtod(&amp;packet[i], &amp;endptr);
00194     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: 'T'</span>
00195     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: course (magnetic north)</span>
00196 
00197     <span class="comment">// get course (magnetic north ref) in degrees [ddd.dd]</span>
00198     <span class="comment">//GpsInfo.VelHS.heading.f = strtod(&amp;packet[i], &amp;endptr);</span>
00199     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: 'M'</span>
00200     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: speed (knots)</span>
00201 
00202     <span class="comment">// get speed in knots</span>
00203     <span class="comment">//GpsInfo.VelHS.speed.f = strtod(&amp;packet[i], &amp;endptr);</span>
00204     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: 'N'</span>
00205     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: speed (km/h)</span>
00206 
00207     <span class="comment">// get speed in km/h</span>
00208     GpsInfo.VelHS.speed.f = strtod(&amp;packet[i], &amp;endptr);
00209     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">','</span>);              <span class="comment">// next field: 'K'</span>
00210     <span class="keywordflow">while</span>(packet[i++] != <span class="charliteral">'*'</span>);              <span class="comment">// next field: checksum</span>
00211 
00212     GpsInfo.VelHS.updates++;
00213 }
00214 
</pre></div><hr><address style="align: right;"><small>Generated on Sun Feb 22 19:12:31 2004 for Procyon AVRlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
