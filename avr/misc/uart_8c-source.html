<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>uart.c Source File</title>
<link href="dox.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc2 -->
<center>
<a class="qindex" href="main.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="annotated.html">Data Structures</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Data Fields</a> &nbsp; <a class="qindex" href="globals.html">Globals</a> &nbsp; </center>
<hr><h1>uart.c</h1><a href="uart_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*! \file uart.c \brief UART driver with buffer support. */</span>
00002 <span class="comment">// *****************************************************************************</span>
00003 <span class="comment">//</span>
00004 <span class="comment">// File Name    : 'uart.c'</span>
00005 <span class="comment">// Title        : UART driver with buffer support</span>
00006 <span class="comment">// Author       : Pascal Stang - Copyright (C) 2000-2002</span>
00007 <span class="comment">// Created      : 11/22/2000</span>
00008 <span class="comment">// Revised      : 06/09/2003</span>
00009 <span class="comment">// Version      : 1.3</span>
00010 <span class="comment">// Target MCU   : ATMEL AVR Series</span>
00011 <span class="comment">// Editor Tabs  : 4</span>
00012 <span class="comment">//</span>
00013 <span class="comment">// This code is distributed under the GNU Public License</span>
00014 <span class="comment">//      which can be found at http://www.gnu.org/licenses/gpl.txt</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// *****************************************************************************</span>
00017 
00018 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
00019 <span class="preprocessor">#include &lt;avr/interrupt.h&gt;</span>
00020 <span class="preprocessor">#include &lt;avr/signal.h&gt;</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="buffer_8h.html">buffer.h</a>"</span>
00023 <span class="preprocessor">#include "<a class="code" href="uart_8h.html">uart.h</a>"</span>
00024 
00025 <span class="comment">// UART global variables</span>
00026 <span class="comment">// flag variables</span>
<a name="l00027"></a><a class="code" href="uart_8c.html#a0">00027</a> <span class="keyword">volatile</span> u08   <a class="code" href="uart_8c.html#a0">uartReadyTx</a>;         <span class="comment">///&lt; uartReadyTx flag</span>
<a name="l00028"></a><a class="code" href="uart_8c.html#a1">00028</a> <span class="comment"></span><span class="keyword">volatile</span> u08   <a class="code" href="uart_8c.html#a1">uartBufferedTx</a>;      <span class="comment">///&lt; uartBufferedTx flag</span>
00029 <span class="comment"></span><span class="comment">// receive and transmit buffers</span>
<a name="l00030"></a><a class="code" href="uart_8c.html#a2">00030</a> cBuffer <a class="code" href="uart_8c.html#a2">uartRxBuffer</a>;               <span class="comment">///&lt; uart receive buffer</span>
<a name="l00031"></a><a class="code" href="uart_8c.html#a3">00031</a> <span class="comment"></span>cBuffer <a class="code" href="uart_8c.html#a3">uartTxBuffer</a>;               <span class="comment">///&lt; uart transmit buffer</span>
<a name="l00032"></a><a class="code" href="uart_8c.html#a4">00032</a> <span class="comment"></span><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="uart_8c.html#a4">uartRxOverflow</a>;      <span class="comment">///&lt; receive overflow counter</span>
00033 <span class="comment"></span>
00034 <span class="preprocessor">#ifndef UART_BUFFERS_EXTERNAL_RAM</span>
00035 <span class="preprocessor"></span>    <span class="comment">// using internal ram,</span>
00036     <span class="comment">// automatically allocate space in ram for each buffer</span>
00037     <span class="keyword">static</span> <span class="keywordtype">char</span> uartRxData[<a class="code" href="uart_8h.html#a2">UART_RX_BUFFER_SIZE</a>];
00038     <span class="keyword">static</span> <span class="keywordtype">char</span> uartTxData[<a class="code" href="uart_8h.html#a1">UART_TX_BUFFER_SIZE</a>];
00039 <span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span>
00041 <span class="keyword">typedef</span> void (*voidFuncPtru08)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>);
00042 <span class="keyword">volatile</span> <span class="keyword">static</span> voidFuncPtru08 UartRxFunc;
00043 <span class="comment"></span>
00044 <span class="comment">//! enable and initialize the uart</span>
<a name="l00045"></a><a class="code" href="uart_8c.html#a9">00045</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a9">uartInit</a>(<span class="keywordtype">void</span>)
00046 {
00047     <span class="comment">// initialize the buffers</span>
00048     <a class="code" href="uart_8c.html#a10">uartInitBuffers</a>();
00049     <span class="comment">// initialize user receive handler</span>
00050     UartRxFunc = 0;
00051 
00052     <span class="comment">// enable RxD/TxD and interrupts</span>
00053     outb(UCR, BV(RXCIE)|BV(TXCIE)|BV(RXEN)|BV(TXEN));
00054 
00055     <span class="comment">// set default baud rate</span>
00056     <a class="code" href="uart_8c.html#a12">uartSetBaudRate</a>(UART_DEFAULT_BAUD_RATE);  
00057     <span class="comment">// initialize states</span>
00058     <a class="code" href="uart_8c.html#a0">uartReadyTx</a> = TRUE;
00059     <a class="code" href="uart_8c.html#a1">uartBufferedTx</a> = FALSE;
00060     <span class="comment">// clear overflow count</span>
00061     <a class="code" href="uart_8c.html#a4">uartRxOverflow</a> = 0;
00062     <span class="comment">// enable interrupts</span>
00063     sei();
00064 }
00065 <span class="comment"></span>
00066 <span class="comment">//! create and initialize the uart transmit and receive buffers</span>
<a name="l00067"></a><a class="code" href="uart_8c.html#a10">00067</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a10">uartInitBuffers</a>(<span class="keywordtype">void</span>)
00068 {
00069 <span class="preprocessor">    #ifndef UART_BUFFERS_EXTERNAL_RAM</span>
00070 <span class="preprocessor"></span>        <span class="comment">// initialize the UART receive buffer</span>
00071         <a class="code" href="buffer_8c.html#a0">bufferInit</a>(&amp;uartRxBuffer, uartRxData, UART_RX_BUFFER_SIZE);
00072         <span class="comment">// initialize the UART transmit buffer</span>
00073         <a class="code" href="buffer_8c.html#a0">bufferInit</a>(&amp;uartTxBuffer, uartTxData, UART_TX_BUFFER_SIZE);
00074 <span class="preprocessor">    #else</span>
00075 <span class="preprocessor"></span>        <span class="comment">// initialize the UART receive buffer</span>
00076         <a class="code" href="buffer_8c.html#a0">bufferInit</a>(&amp;uartRxBuffer, (u08*) UART_RX_BUFFER_ADDR, UART_RX_BUFFER_SIZE);
00077         <span class="comment">// initialize the UART transmit buffer</span>
00078         <a class="code" href="buffer_8c.html#a0">bufferInit</a>(&amp;uartTxBuffer, (u08*) UART_TX_BUFFER_ADDR, UART_TX_BUFFER_SIZE);
00079 <span class="preprocessor">    #endif</span>
00080 <span class="preprocessor"></span>}
00081 <span class="comment"></span>
00082 <span class="comment">//! redirects received data to a user function</span>
<a name="l00083"></a><a class="code" href="uart_8c.html#a11">00083</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a11">uartSetRxHandler</a>(<span class="keywordtype">void</span> (*rx_func)(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c))
00084 {
00085     <span class="comment">// set the receive interrupt to run the supplied user function</span>
00086     UartRxFunc = rx_func;
00087 }
00088 <span class="comment"></span>
00089 <span class="comment">//! set the uart baud rate</span>
<a name="l00090"></a><a class="code" href="uart_8c.html#a12">00090</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a12">uartSetBaudRate</a>(u32 baudrate)
00091 {
00092     <span class="comment">// calculate division factor for requested baud rate, and set it</span>
00093     u16 bauddiv = ((F_CPU+(baudrate*8L))/(baudrate*16L)-1);
00094     outb(UBRRL, bauddiv);
00095 <span class="preprocessor">    #ifdef UBRRH</span>
00096 <span class="preprocessor"></span>    outb(UBRRH, bauddiv&gt;&gt;8);
00097 <span class="preprocessor">    #endif</span>
00098 <span class="preprocessor"></span>}
00099 <span class="comment"></span>
00100 <span class="comment">//! returns the receive buffer structure </span>
<a name="l00101"></a><a class="code" href="uart_8c.html#a13">00101</a> <span class="comment"></span>cBuffer* <a class="code" href="uart_8c.html#a13">uartGetRxBuffer</a>(<span class="keywordtype">void</span>)
00102 {
00103     <span class="comment">// return rx buffer pointer</span>
00104     <span class="keywordflow">return</span> &amp;<a class="code" href="uart_8c.html#a2">uartRxBuffer</a>;
00105 }
00106 <span class="comment"></span>
00107 <span class="comment">//! returns the transmit buffer structure </span>
<a name="l00108"></a><a class="code" href="uart_8c.html#a14">00108</a> <span class="comment"></span>cBuffer* <a class="code" href="uart_8c.html#a14">uartGetTxBuffer</a>(<span class="keywordtype">void</span>)
00109 {
00110     <span class="comment">// return tx buffer pointer</span>
00111     <span class="keywordflow">return</span> &amp;<a class="code" href="uart_8c.html#a3">uartTxBuffer</a>;
00112 }
00113 <span class="comment"></span>
00114 <span class="comment">//! transmits a byte over the uart</span>
<a name="l00115"></a><a class="code" href="uart_8c.html#a15">00115</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a15">uartSendByte</a>(u08 txData)
00116 {
00117     <span class="comment">// wait for the transmitter to be ready</span>
00118     <span class="keywordflow">while</span>(!<a class="code" href="uart_8c.html#a0">uartReadyTx</a>);
00119     <span class="comment">// send byte</span>
00120     outp( txData, UDR );
00121     <span class="comment">// set ready state to FALSE</span>
00122     <a class="code" href="uart_8c.html#a0">uartReadyTx</a> = FALSE;
00123 }
00124 <span class="comment"></span>
00125 <span class="comment">//! gets a byte (if available) from the uart receive buffer</span>
<a name="l00126"></a><a class="code" href="uart_8c.html#a16">00126</a> <span class="comment"></span>u08 <a class="code" href="uart_8c.html#a16">uartReceiveByte</a>(u08* rxData)
00127 {
00128     <span class="comment">// make sure we have a receive buffer</span>
00129     <span class="keywordflow">if</span>(<a class="code" href="uart_8c.html#a2">uartRxBuffer</a>.size)
00130     {
00131         <span class="comment">// make sure we have data</span>
00132         <span class="keywordflow">if</span>(<a class="code" href="uart_8c.html#a2">uartRxBuffer</a>.datalength)
00133         {
00134             <span class="comment">// get byte from beginning of buffer</span>
00135             *rxData = <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(&amp;uartRxBuffer);
00136             <span class="keywordflow">return</span> TRUE;
00137         }
00138         <span class="keywordflow">else</span>
00139         {
00140             <span class="comment">// no data</span>
00141             <span class="keywordflow">return</span> FALSE;
00142         }
00143     }
00144     <span class="keywordflow">else</span>
00145     {
00146         <span class="comment">// no buffer</span>
00147         <span class="keywordflow">return</span> FALSE;
00148     }
00149 }
00150 <span class="comment"></span>
00151 <span class="comment">//! flush all data out of the receive buffer</span>
<a name="l00152"></a><a class="code" href="uart_8c.html#a17">00152</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a17">uartFlushReceiveBuffer</a>(<span class="keywordtype">void</span>)
00153 {
00154     <span class="comment">// flush all data from receive buffer</span>
00155     <span class="comment">//bufferFlush(&amp;uartRxBuffer);</span>
00156     <span class="comment">// same effect as above</span>
00157     <a class="code" href="uart_8c.html#a2">uartRxBuffer</a>.datalength = 0;
00158 }
00159 <span class="comment"></span>
00160 <span class="comment">//! return true if uart receive buffer is empty</span>
<a name="l00161"></a><a class="code" href="uart_8c.html#a18">00161</a> <span class="comment"></span>u08 <a class="code" href="uart_8c.html#a18">uartReceiveBufferIsEmpty</a>(<span class="keywordtype">void</span>)
00162 {
00163     <span class="keywordflow">if</span>(<a class="code" href="uart_8c.html#a2">uartRxBuffer</a>.datalength == 0)
00164     {
00165         <span class="keywordflow">return</span> TRUE;
00166     }
00167     <span class="keywordflow">else</span>
00168     {
00169         <span class="keywordflow">return</span> FALSE;
00170     }
00171 }
00172 <span class="comment"></span>
00173 <span class="comment">//! add byte to end of uart Tx buffer</span>
<a name="l00174"></a><a class="code" href="uart_8c.html#a19">00174</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart2_8c.html#a23">uartAddToTxBuffer</a>(u08 data)
00175 {
00176     <span class="comment">// add data byte to the end of the tx buffer</span>
00177     <a class="code" href="buffer_8c.html#a4">bufferAddToEnd</a>(&amp;uartTxBuffer, data);
00178 }
00179 <span class="comment"></span>
00180 <span class="comment">//! start transmission of the current uart Tx buffer contents</span>
<a name="l00181"></a><a class="code" href="uart_8c.html#a20">00181</a> <span class="comment"></span><span class="keywordtype">void</span> <a class="code" href="uart_8c.html#a20">uartSendTxBuffer</a>(<span class="keywordtype">void</span>)
00182 {
00183     <span class="comment">// turn on buffered transmit</span>
00184     <a class="code" href="uart_8c.html#a1">uartBufferedTx</a> = TRUE;
00185     <span class="comment">// send the first byte to get things going by interrupts</span>
00186     <a class="code" href="uart_8c.html#a15">uartSendByte</a>(<a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(&amp;uartTxBuffer));
00187 }
00188 <span class="comment">/*</span><span class="comment"></span>
00189 <span class="comment">//! transmit nBytes from buffer out the uart</span>
00190 <span class="comment"></span>u08 uartSendBuffer(char *buffer, u16 nBytes)
00191 {
00192     register u08 first;
00193     register u16 i;
00194 
00195     // check if there's space (and that we have any bytes to send at all)
00196     if((uartTxBuffer.datalength + nBytes &lt; uartTxBuffer.size) &amp;&amp; nBytes)
00197     {
00198         // grab first character
00199         first = *buffer++;
00200         // copy user buffer to uart transmit buffer
00201         for(i = 0; i &lt; nBytes-1; i++)
00202         {
00203             // put data bytes at end of buffer
00204             bufferAddToEnd(&amp;uartTxBuffer, *buffer++);
00205         }
00206 
00207         // send the first byte to get things going by interrupts
00208         uartBufferedTx = TRUE;
00209         uartSendByte(first);
00210         // return success
00211         return TRUE;
00212     }
00213     else
00214     {
00215         // return failure
00216         return FALSE;
00217     }
00218 }
00219 */<span class="comment"></span>
00220 <span class="comment">//! UART Transmit Complete Interrupt Handler</span>
<a name="l00221"></a><a class="code" href="uart_8c.html#a21">00221</a> <span class="comment"></span><a class="code" href="uart_8c.html#a21">UART_INTERRUPT_HANDLER</a>(SIG_UART_TRANS)
00222 {
00223     <span class="comment">// check if buffered tx is enabled</span>
00224     <span class="keywordflow">if</span>(uartBufferedTx)
00225     {
00226         <span class="comment">// check if there's data left in the buffer</span>
00227         <span class="keywordflow">if</span>(<a class="code" href="uart_8c.html#a3">uartTxBuffer</a>.datalength)
00228         {
00229             <span class="comment">// send byte from top of buffer</span>
00230             outp( <a class="code" href="buffer_8c.html#a1">bufferGetFromFront</a>(&amp;uartTxBuffer), UDR );
00231         }
00232         <span class="keywordflow">else</span>
00233         {
00234             <span class="comment">// no data left</span>
00235             <a class="code" href="uart_8c.html#a1">uartBufferedTx</a> = FALSE;
00236             <span class="comment">// return to ready state</span>
00237             <a class="code" href="uart_8c.html#a0">uartReadyTx</a> = TRUE;
00238         }
00239     }
00240     <span class="keywordflow">else</span>
00241     {
00242         <span class="comment">// we're using single-byte tx mode</span>
00243         <span class="comment">// indicate transmit complete, back to ready</span>
00244         <a class="code" href="uart_8c.html#a0">uartReadyTx</a> = TRUE;
00245     }
00246 }
00247 <span class="comment"></span>
00248 <span class="comment">//! UART Receive Complete Interrupt Handler</span>
00249 <span class="comment"></span><a class="code" href="uart_8c.html#a21">UART_INTERRUPT_HANDLER</a>(SIG_UART_RECV)
00250 {
00251     u08 c;
00252     
00253     <span class="comment">// get received char</span>
00254     c = inp(UDR);
00255 
00256     <span class="comment">// if there's a user function to handle this receive event</span>
00257     <span class="keywordflow">if</span>(UartRxFunc)
00258     {
00259         <span class="comment">// call it and pass the received data</span>
00260         UartRxFunc(c);
00261     }
00262     <span class="keywordflow">else</span>
00263     {
00264         <span class="comment">// otherwise do default processing</span>
00265         <span class="comment">// put received char in buffer</span>
00266         <span class="comment">// check if there's space</span>
00267         <span class="keywordflow">if</span>( !<a class="code" href="buffer_8c.html#a4">bufferAddToEnd</a>(&amp;uartRxBuffer, c) )
00268         {
00269             <span class="comment">// no space in buffer</span>
00270             <span class="comment">// count overflow</span>
00271             <a class="code" href="uart_8c.html#a4">uartRxOverflow</a>++;
00272         }
00273     }
00274 }
</pre></div><hr><address style="align: right;"><small>Generated on Sun Feb 22 19:12:31 2004 for Procyon AVRlib by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc2 </small></address>
</body>
</html>
